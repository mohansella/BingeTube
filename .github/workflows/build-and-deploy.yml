name: Build and Deploy

on:
  push:
    branches: [ master ]

permissions:
  contents: write

jobs:
  version-check:
    runs-on: ubuntu-latest
    outputs:
      is_bump: ${{ steps.check.outputs.changed }}
      version: ${{ steps.check.outputs.version }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2
          lfs: true
      - id: check
        run: |
          NEW_VER=$(grep 'version:' pubspec.yaml | cut -d' ' -f2 | xargs)
          OLD_VER=$(git show HEAD~1:pubspec.yaml | grep 'version:' | cut -d' ' -f2 | xargs || echo "0.0.0")
          if [ "$NEW_VER" != "$OLD_VER" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "version=$NEW_VER" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi
          echo "new version: $NEW_VER old version: $OLD_VER"

  flutter-web:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build web --release --base-href=/app/
      - uses: actions/upload-artifact@v4
        with:
          name: flutter-web
          path: build/web

  flutter-android:
    runs-on: ubuntu-latest
    needs: version-check
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build apk --debug
      - run: |
          mv build/app/outputs/flutter-apk/app-debug.apk \
             "android-debug-v${{ needs.version-check.outputs.version }}.apk"
      - uses: actions/upload-artifact@v4
        with:
          name: android-debug-apk
          path: android-debug-*.apk

  flutter-ios:
    runs-on: macos-latest
    needs: version-check
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build ipa --release --no-codesign
      - name: Package iOS IPA
        run: |
          # Create IPA from xcarchive (unsigned)
          cd build/ios/archive/
          mkdir Payload
          cp -r Runner.xcarchive/Products/Applications/Runner.app Payload/
          cp -r Runner.xcarchive/SwiftSupport ./ 2>/dev/null || true
          zip -r "ios-v${{ needs.version-check.outputs.version }}.ipa" Payload SwiftSupport
          mv ios-v${{ needs.version-check.outputs.version }}.ipa ../../
          cd ../../
      - uses: actions/upload-artifact@v4
        with:
          name: ios-ipa
          path: ios-*.ipa

  flutter-windows:
    runs-on: windows-latest
    needs: version-check
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build windows --release
      - name: Package Windows
        shell: pwsh
        run: |
          Compress-Archive -Path "build/windows/x64/runner/Release/*" -DestinationPath "$env:GITHUB_WORKSPACE/windows-v${{ needs.version-check.outputs.version }}.zip"
      - uses: actions/upload-artifact@v4
        with:
          name: windows-bin
          path: windows-*.zip
          compression-level: 0

  flutter-macos:
    runs-on: macos-latest
    needs: version-check
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: flutter pub get
      - run: flutter build macos --release
      - name: Package macOS
        shell: bash
        run: |
          APP_PATH="build/macos/Build/Products/Release/BingeTube.app"
          cd $(dirname "$APP_PATH")
          zip -r "$GITHUB_WORKSPACE/macos-v${{ needs.version-check.outputs.version }}.zip" "BingeTube.app"
      - uses: actions/upload-artifact@v4
        with:
          name: macos-bin
          path: macos-*.zip
          compression-level: 9

  flutter-linux:
    runs-on: ubuntu-latest
    needs: version-check
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true
      - run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libblkid-dev liblzma-dev libsecret-1-dev pkg-config
      - run: flutter pub get
      - run: flutter build linux --release
      - name: Package Linux
        shell: bash
        run: |
          cd build/linux/x64/release/bundle
          zip -r "$GITHUB_WORKSPACE/linux-v${{ needs.version-check.outputs.version }}.zip" .
      - uses: actions/upload-artifact@v4
        with:
          name: linux-bin
          path: linux-*.zip
          compression-level: 0

  astro-site:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          lfs: true
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'npm'
          cache-dependency-path: website/package-lock.json
      - working-directory: website
        run: |
          npm ci
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: astro-site
          path: website/dist

  deploy:
    runs-on: ubuntu-latest
    needs: [version-check, flutter-web, astro-site]
    steps:
      - uses: actions/download-artifact@v4
        with: { name: flutter-web, path: dist/app }
      - uses: actions/download-artifact@v4
        with: { name: astro-site, path: dist }
      - uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: bingetube
          directory: dist
          branch: ${{ needs.version-check.outputs.is_bump == 'true' && 'master' || 'preview' }}

  release:
    runs-on: ubuntu-latest
    needs: [version-check, flutter-android, flutter-ios, flutter-windows, flutter-macos, flutter-linux]
    if: needs.version-check.outputs.is_bump == 'true'
    steps:
      - uses: actions/download-artifact@v4
        with: { path: artifacts }
      - uses: softprops/action-gh-release@v2
        with:
          tag_name: v${{ needs.version-check.outputs.version }}
          name: Release v${{ needs.version-check.outputs.version }}
          files: |
            artifacts/**/*.zip
            artifacts/**/*.apk
            artifacts/**/*.ipa
          generate_release_notes: true
